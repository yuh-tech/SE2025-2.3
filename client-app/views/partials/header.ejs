<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title || 'Sunshine Boutique' %></title>

  <!-- CSS -->
  <link rel="stylesheet" href="/style.css?v=<%= Date.now() %>">
</head>

<body>

<header>
  <div class="container">
    
    <!-- Logo -->
    <a href="/" class="logo">Sunshine Boutique</a>
    <nav>

    <a href="/products">Sản phẩm</a>

   <% if (!currentUser) { %>

      <!-- CHƯA LOGIN -->
      <a href="/login">Đăng nhập</a>
      <a href="/signup">Đăng ký</a>

    <% } else if (currentUser.role === 'admin') { %>

      <!-- ADMIN -->
      <span>Xin chào, Admin</span>
      <a href="/admin" style="font-weight:bold; color:#ff6600;">Trang Admin</a>

      <form action="/logout" method="POST" style="display:inline;">
        <button type="submit"
                style="background:none; border:none; color:inherit; cursor:pointer; margin-left:15px;">
          Đăng xuất
        </button>
      </form>

    <% } else { %>

      <!-- CUSTOMER -->
      <span>Xin chào, <%= currentUser.displayName %></span>

      <a href="/cart" style="position:relative;">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.2">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 
                   2 0 0 0 2-1.61L23 6H6"></path>
        </svg>

        <span id="cartCount"
              style="
                position:absolute;top:-8px;right:-8px;
                background:red;color:white;
                display:none;min-width:20px;height:20px;
                justify-content:center;align-items:center;
                border-radius:50%;font-size:12px;font-weight:bold;">
        </span>
      </a>

      <form action="/logout" method="POST" style="display:inline;">
        <button type="submit"
                style="background:none; border:none; color:inherit; cursor:pointer; margin-left:15px;">
          Đăng xuất
        </button>
      </form>

    <% } %>

  </nav>

  </div>
</header>


<!-- ==============================
       SCRIPT CẬP NHẬT GIỎ HÀNG 
     ============================== -->
<script>
  // Hàm cập nhật badge
  function updateCartBadge(count) {
    const badge = document.getElementById('cartCount');
    if (!badge) return;

    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }

  
  // Lấy số lượng giỏ hàng khi tải trang
  fetch('/cart/count', { credentials: "include" })
    .then(r => r.json())
    .then(data => updateCartBadge(data.count || 0))
    .catch(err => console.log("Không lấy được cart count:", err));

  // Cho phép các trang con gọi để cập nhật realtime
  window.updateCartBadge = updateCartBadge;
</script>
