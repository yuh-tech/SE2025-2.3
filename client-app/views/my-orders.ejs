<%- include('partials/header') %>

<div class="container my-orders-page">
  <div class="page-head">
    <h1>Đơn mua</h1>
    <a class="back-dashboard" href="/">Tiếp tục mua sắm</a>
  </div>

  <% const current = String(status || 'all'); %>

  <div class="tabs">
    <a class="tab <%= current==='all' ? 'active' : '' %>" href="/my-orders">Tất cả</a>

    <a class="tab <%= current==='pending' ? 'active' : '' %>"
      href="/my-orders?status=pending">Chờ xử lý</a>

    <a class="tab <%= current==='processing' ? 'active' : '' %>"
      href="/my-orders?status=processing">Đang xử lý</a>

    <a class="tab <%= current==='shipping' ? 'active' : '' %>"
      href="/my-orders?status=shipping">Đang giao</a>

    <a class="tab <%= current==='done' ? 'active' : '' %>"
      href="/my-orders?status=done">Hoàn tất</a>

    <a class="tab <%= current==='return_requested' ? 'active' : '' %>"
      href="/my-orders?status=return_requested">Yêu cầu hoàn</a>

    <a class="tab <%= current==='returning' ? 'active' : '' %>"
      href="/my-orders?status=returning">Đang hoàn</a>

    <a class="tab <%= current==='returned' ? 'active' : '' %>"
      href="/my-orders?status=returned">Đã hoàn</a>

    <a class="tab <%= current==='cancelled' ? 'active' : '' %>"
      href="/my-orders?status=cancelled">Đã huỷ</a>
  </div>


  <% const safeOrders = Array.isArray(orders) ? orders : []; %>

  <% if (safeOrders.length === 0) { %>
    <div class="empty">
      <p>Bạn chưa có đơn hàng nào.</p>
      <a href="/products" class="btn">Mua sắm ngay</a>
    </div>
  <% } else { %>
    <div class="orders-list">
      <% safeOrders.forEach(o => { %>
        <% safeOrders.forEach(o => { %>
        <div class="order-card">
          <a class="order-link" href="/orders/<%= o.id %>">
            <div class="left">
              <div class="code">Mã đơn: <strong>#<%= o.id %></strong></div>
              <div class="time">Ngày tạo: <%= o.created_at %></div>
            </div>
            <div class="right">
              <div class="total"><%= (o.total || 0).toLocaleString('vi-VN') %> ₫</div>

              <% if (String(o.status) === 'done') { %>
                <% if (Number(o.reviewedFlag || 0) === 1) { %>
                  <span class="badge reviewed">Đã đánh giá</span>
                <% } else { %>
                  <span class="badge not-reviewed">Đánh giá ngay</span>
                <% } %>
              <% } else { %>
                <span class="badge"><%= o.status %></span>
              <% } %>
            </div>
          </a>

          <% if (['pending','processing'].includes(String(o.status))) { %>
            <form class="cancel-form" method="POST" action="/orders/<%= o.id %>/cancel"
                  onsubmit="return confirm('Bạn chắc chắn muốn huỷ đơn #<%= o.id %> chứ?');">
              <button type="submit" class="btn-cancel">Huỷ đơn</button>
            </form>
          <% } %>
        </div>
      <% }) %>

      <% }) %>
    </div>
  <% } %>
</div>

<%- include('partials/footer') %>

<style>
  .my-orders-page{max-width:1100px;margin:30px auto;padding:0 18px}
  .page-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .page-head h1{margin:0;font-size:28px}
  .back-dashboard{padding:10px 14px;border-radius:12px;background:#4e73df;color:#fff;text-decoration:none}
  .tabs{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 18px}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;text-decoration:none;color:#333;background:#fff}
  .orders-list{display:flex;flex-direction:column;gap:12px}
  .order-card{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:14px;padding:14px 16px;
    text-decoration:none;color:inherit;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .code{font-size:15px;margin-bottom:6px}
  .time{font-size:13px;color:#6b7280}
  .total{font-weight:800;font-size:16px;margin-bottom:6px;text-align:right}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:13px}
  .empty{text-align:center;padding:60px 10px}
  .btn{display:inline-block;margin-top:12px;padding:12px 18px;border-radius:999px;background:#a8e6cf;color:#155d42;text-decoration:none;font-weight:700}
  .tabs {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.tab {
  padding: 10px 16px;
  border-radius: 999px;
  border: 1px solid #ddd;
  text-decoration: none;
  font-weight: 600;
  color: #333;
  background: #fff;
  transition: all .2s ease;
}

.tab:hover {
  background: #f0f6ff;
}

.tab.active {
  background: #4e73df;
  color: #fff;
  border-color: #4e73df;
}

.badge.reviewed{
  background:#dff7ea;
  color:#136b3a;
  font-weight:700;
}
.badge.not-reviewed{
  background:#ffe1ef;
  color:#b0004f;
  font-weight:700;
}

.order-card{
  position:relative;
  background:#fff;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  overflow:hidden;
}

.order-link{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  text-decoration:none;
  color:inherit;
}

.cancel-form{
  position:absolute;
  right:14px;
  bottom:12px;
}

.btn-cancel{
  border:none;
  border-radius:999px;
  padding:8px 12px;
  font-weight:800;
  cursor:pointer;
  background:#ffe1e1;
  color:#9b1c1c;
}

.btn-cancel:hover{ filter:brightness(.97); }

</style>
