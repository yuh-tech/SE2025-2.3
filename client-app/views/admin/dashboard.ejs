<%- include('../partials/header') %>

<div class="admin-container">

  <h1 class="admin-title">Admin Dashboard</h1>

  <!-- ===== STAT CARDS ===== -->
  <div class="stats-grid">
    <div class="stat-card card-products">
      <a href="/admin/products" style="display:flex; align-items:center; text-decoration:none; color:inherit;">
        <div class="card-icon">üì¶</div>
        <div class="card-info">
          <h3>T·ªïng s·∫£n ph·∫©m</h3>
          <p><%= productsCount %></p>
        </div>
      </a>
    </div>

    <a href="/admin/customers" class="stat-card card-customers stat-link">
      <div class="card-icon">üë•</div>
      <div class="card-info">
        <h3>T·ªïng kh√°ch h√†ng</h3>
        <p><%= typeof customersCount !== 'undefined' ? customersCount : 0 %></p>
      </div>
    </a>

    
    <a href="/admin/orders?status=pending" class="stat-card card-orders stat-link">
      <div class="card-icon">üõí</div>
      <div class="card-info">
        <h3>T·ªïng ƒë∆°n h√†ng</h3>
        <p><%= typeof ordersCount !== 'undefined' ? ordersCount : 0 %></p>

        <div class="card-sub">
          Ch·ªù x·ª≠ l√Ω: <strong><%= typeof pendingCount !== 'undefined' ? pendingCount : 0 %></strong>
        </div>
      </div>
    </a>

    <a href="/admin/revenue" class="stat-card card-revenue stat-link">
      <div class="card-icon">üí∞</div>
      <div class="card-info">
        <h3>Doanh thu</h3>
        <p><%= (typeof totalRevenue !== 'undefined' ? totalRevenue : 0).toLocaleString('vi-VN') %> ‚Ç´</p>
      </div>
    </a>

  </div>

  <!-- ===== B·∫¢NG S·∫¢N PH·∫®M B√ÅN H√îM NAY ===== -->
  <h2>S·∫£n ph·∫©m b√°n h√¥m nay</h2>
  <div class="table-container">
    <table class="styled-table">
      <thead>
        <tr>
          <th>S·∫£n ph·∫©m</th>
          <th>Kh√°ch h√†ng</th>
          <th>S·ªë l∆∞·ª£ng</th>
        </tr>
      </thead>
      <tbody>
        <% const safeSalesToday = Array.isArray(salesToday) ? salesToday : []; %>
        <% if (safeSalesToday.length === 0) { %>
          <tr><td colspan="3">Ch∆∞a c√≥ ƒë∆°n h√†ng h√¥m nay</td></tr>
        <% } else { %>
          <% safeSalesToday.forEach(s => { %>
            <tr>
              <td><%= s.product_name || '' %></td>
              <td><%= s.customer_name || '' %></td>
              <td><%= s.sold || 0 %></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>

    </table>
  </div>

  <!-- ===== BI·ªÇU ƒê·ªí DOANH THU 7 NG√ÄY ===== -->
  <h2>Doanh thu 7 ng√†y g·∫ßn nh·∫•t</h2>
  <canvas id="revenueChart"></canvas>

    <!-- ===== TOP 5 PRODUCTS ===== -->
  <div class="top5-grid">
    <!-- Top 5 theo s·ªë l∆∞·ª£ng -->
    <div class="top5-card">
      <div class="top5-head">
        <h3>Top 5 b√°n ch·∫°y (theo s·ªë l∆∞·ª£ng)</h3>
        <span class="hint">7 ng√†y g·∫ßn nh·∫•t</span>
      </div>

      <% const safeTopQty = (typeof topQty !== 'undefined' && Array.isArray(topQty)) ? topQty : []; %>
      <% if (safeTopQty.length === 0) { %>
        <div class="empty-mini">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
      <% } else { %>
        <table class="mini-table">
          <thead>
            <tr>
              <th style="width:52px;">#</th>
              <th>S·∫£n ph·∫©m</th>
              <th style="width:120px;text-align:right;">ƒê√£ b√°n</th>
            </tr>
          </thead>
          <tbody>
            <% safeTopQty.forEach((p, idx) => { %>
              <tr>
                <td><span class="rank">#<%= idx + 1 %></span></td>
                <td><%= p.product_name || p.name || '‚Äî' %></td>
                <td style="text-align:right;"><strong><%= p.sold ?? p.qty ?? 0 %></strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- Top 5 theo doanh thu -->
    <div class="top5-card">
      <div class="top5-head">
        <h3>Top 5 doanh thu cao nh·∫•t</h3>
        <span class="hint">7 ng√†y g·∫ßn nh·∫•t</span>
      </div>

      <% const safeTopRevenue = (typeof topRevenue !== 'undefined' && Array.isArray(topRevenue)) ? topRevenue : []; %>
      <% if (safeTopRevenue.length === 0) { %>
        <div class="empty-mini">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
      <% } else { %>
        <table class="mini-table">
          <thead>
            <tr>
              <th style="width:52px;">#</th>
              <th>S·∫£n ph·∫©m</th>
              <th style="width:160px;text-align:right;">Doanh thu</th>
            </tr>
          </thead>
          <tbody>
            <% safeTopRevenue.forEach((p, idx) => { %>
              <tr>
                <td><span class="rank">#<%= idx + 1 %></span></td>
                <td><%= p.product_name || p.name || '‚Äî' %></td>
                <td style="text-align:right;"><strong><%= (p.revenue ?? p.total ?? 0).toLocaleString('vi-VN') %> ‚Ç´</strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </div>

</div>

<%- include('../partials/footer') %>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chuy·ªÉn d·ªØ li·ªáu t·ª´ server (EJS) sang JS an to√†n
  const safeRevenueWeek = <%- JSON.stringify(Array.isArray(revenueWeek) ? revenueWeek : []) %>;

  const labels = safeRevenueWeek.map(r => r.day || '');
  const data = safeRevenueWeek.map(r => Number(r.revenue || 0));

  const canvas = document.getElementById('revenueChart');

  // N·∫øu kh√¥ng c√≥ data -> show message
  if (!labels.length) {
    // t·∫°o 1 d√≤ng ch·ªØ thay v√¨ chart tr·ªëng
    const p = document.createElement('p');
    p.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu 7 ng√†y g·∫ßn nh·∫•t.';
    p.style.color = '#666';
    p.style.marginTop = '12px';
    canvas.insertAdjacentElement('afterend', p);
  } else {
    new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Doanh thu (‚Ç´)',
          data,
          borderColor: '#4e73df',
          backgroundColor: 'rgba(78, 115, 223, 0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>


<style>
.admin-container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
  font-family: 'Segoe UI', sans-serif;
}

.admin-title {
  text-align: center;
  font-size: 36px;
  margin-bottom: 30px;
  color: #333;
}

/* ===== STAT CARDS ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.stat-card {
  display: flex;
  align-items: center;
  background: #fff;
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}

.stat-card:hover { transform: translateY(-5px); }

.card-icon {
  font-size: 40px;
  margin-right: 15px;
}

.card-info h3 {
  margin: 0;
  font-size: 18px;
  color: #555;
}

.card-info p {
  margin: 5px 0 0 0;
  font-size: 24px;
  font-weight: bold;
  color: #111;
}

/* Card colors */
.card-products { border-left: 5px solid #1cc88a; }
.card-customers { border-left: 5px solid #36b9cc; }
.card-orders { border-left: 5px solid #f6c23e; }
.card-revenue { border-left: 5px solid #e74a3b; }

/* ===== TABLE ===== */
.table-container { overflow-x: auto; margin-bottom: 40px; }
.styled-table {
  width: 100%;
  border-collapse: collapse;
}
.styled-table th, .styled-table td {
  padding: 12px 15px;
  text-align: left;
}
.styled-table thead tr {
  background-color: #4e73df;
  color: #fff;
  text-align: left;
  font-weight: bold;
}
.styled-table tbody tr {
  border-bottom: 1px solid #ddd;
}
.styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
.styled-table tbody tr:hover { background-color: #f1f1f1; }

/* ===== CHART ===== */
canvas#revenueChart { width: 100% !important; max-height: 300px; }
.stat-link {
  text-decoration: none;
  color: inherit;
  display: flex;
  align-items: center;
}
.card-sub {
  margin-top: 6px;
  font-size: 13px;
  color: #666;
}
.card-sub strong {
  color: #111;
}
/* ===== TOP 5 ===== */
.top5-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  margin-top:18px;
  margin-bottom:20px;
}
.top5-card{
  background:#fff;
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  padding:14px 14px 10px;
}
.top5-head{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  gap:12px;
  margin-bottom:10px;
}
.top5-head h3{ margin:0; font-size:16px; color:#222; }
.hint{ font-size:12px; color:#6b7280; }

.mini-table{ width:100%; border-collapse:collapse; }
.mini-table th,.mini-table td{ padding:10px 10px; border-bottom:1px solid #eee; }
.mini-table th{ font-size:12px; color:#6b7280; font-weight:700; }
.rank{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  background:#f3f4f6;
  font-weight:800;
  font-size:12px;
  color:#111;
}
.empty-mini{
  padding:14px;
  color:#6b7280;
  background:#f9fafb;
  border:1px dashed #e5e7eb;
  border-radius:12px;
}

/* mobile */
@media (max-width: 900px){
  .top5-grid{ grid-template-columns: 1fr; }
}




</style>
