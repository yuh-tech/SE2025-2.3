<%- include('../partials/header') %>

<div class="admin-container">
  <h1>Quản lý sản phẩm</h1>

  <!-- FORM THÊM SẢN PHẨM -->
  <form action="/admin/products/add" method="POST" enctype="multipart/form-data" class="product-form">

    <div class="row">
      <label>Tên sản phẩm</label>
      <input type="text" name="name" required />
    </div>

    <div class="row">
      <label>Giá gốc</label>
      <input type="number" name="price" required />
    </div>

    <div class="row">
      <label>Giá sale</label>
      <input type="number" name="salePrice" placeholder="0 nếu không sale" />
    </div>

    <div class="row">
      <label>Short mô tả</label>
      <input type="text" name="shortDesc" maxlength="200" required />
    </div>

    <div class="row">
      <label>Ảnh sản phẩm</label>
      <input type="file" name="images" accept="image/*" multiple required />
      <small>Bạn có thể chọn nhiều ảnh. Ảnh đầu tiên sẽ là ảnh chính.</small>
    </div>


    <div class="row">
      <label>Danh mục</label>
      <input type="text" name="category" required />
    </div>

    <!-- COLOR - SIZE - QUANTITY -->
    <div class="row">
      <label>Thêm màu + size + SL</label>
      <div id="variant-wrapper"></div>

      <button type="button" class="add-variant-btn">+ Thêm biến thể</button>
    </div>

    <div class="row">
      <label>Mô tả chi tiết</label>
      <textarea name="description" rows="4" required></textarea>
    </div>

    <div class="row">
      <label>Trạng thái</label>
      <select name="status" id="status-select">
        <option value="normal">Bình thường</option>
        <option value="sale">Đang Sale</option>
        <option value="hidden">Ẩn</option>
      </select>
    </div>

    <button class="admin-btn">Thêm sản phẩm</button>
  </form>

  <!-- DANH SÁCH -->
  <div class="admin-card">
    <h2>Danh sách sản phẩm</h2>

    <table class="admin-table">
      <thead>
        <tr>
          <th>Ảnh</th>
          <th>Tên</th>
          <th>Mô tả ngắn</th>
          <th>Giá</th>
          <th>Sale</th>
          <th>Danh mục</th>
          <th>Colors</th>
          <th>Variants</th>
          <th>Trạng thái</th>
          <th>Xóa</th>
        </tr>
      </thead>

      <tbody>
        <% products.forEach(p => { 
             const imgs = p.images ? p.images.split(',') : [];
        %>
        <tr>

          <!-- Ảnh đại diện -->
          <td>
            <% if (imgs.length > 0) { %>
              <img src="/uploads/<%= imgs[0] %>" class="product-img" />
              <% if (imgs.length > 1) { %>
                <button onclick="showImages('<%= imgs.join(',') %>')">+Ảnh</button>
              <% } %>
            <% } else { %>
              Không có ảnh
            <% } %>
          </td>

          <td><%= p.name %></td>

          <td><%= p.shortDesc %></td>

          <!-- Giá -->
          <td><%= p.price.toLocaleString('vi-VN') %>₫</td>

          <!-- Sale -->
          <td>
            <% if (p.salePrice > 0) { %>
              <span style="color:green; font-weight:bold;">✓ <%= p.salePrice.toLocaleString('vi-VN') %> ₫</span>
            <% } else { %>
              <span style="color:red; font-weight:bold;">✗</span>
            <% } %>
          </td>


          <td><%= p.category %></td>

          <!-- Colors -->
          <td>
            <% if (p.variants) {
                 const colors = [...new Set(p.variants.split(',').map(v => v.split(':')[0]))];
            %>
              <%= colors.join(', ') %>
            <% } else { %>Không có<% } %>
          </td>

          <!-- FULL VARIANT -->
          <td>
            <% if (p.variants) { 
                 p.variants.split(',').forEach(v => {
                   const [color, size, qty] = v.split(':');
            %>
              <div><strong><%= color %></strong> — <%= size %> : <%= qty %> cái</div>
            <% }) } else { %>
              Không có
            <% } %>
          </td>

          <!-- Status -->
          <td>
            <span class="status <%= p.status %>">
              <% if (p.status === 'normal') { %>Bình thường
              <% } else if (p.status === 'sale') { %><span style="color:red">Sale</span>
              <% } else { %><span style="opacity:0.5">Ẩn</span>
              <% } %>
            </span>
          </td>

          <!-- DELETE -->
          <td>
            <form method="POST" action="/admin/products/delete/<%= p.id %>"
              onsubmit="return confirm('Xóa sản phẩm này?')">
              <button class="delete-btn">Xóa</button>
            </form>
          </td>

        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Popup xem ảnh phụ
  function showImages(list) {
    alert("Các ảnh:\n" + list.split(',').join('\n'));
  }

  // THÊM 1 DÒNG VARIANT
  document.querySelector(".add-variant-btn").onclick = () => {
    const wrapper = document.getElementById("variant-wrapper");

    const row = document.createElement("div");
    row.className = "variant-row";

    row.innerHTML = `
      <input type="text" name="variant_color[]" placeholder="Màu">
      <input type="text" name="variant_size[]" placeholder="Size">
      <input type="number" name="variant_quantity[]" placeholder="SL">
      <button type="button" class="remove-variant">×</button>
    `;

    row.querySelector(".remove-variant").onclick = () => row.remove();

    wrapper.appendChild(row);
  };

document.getElementById("sale-price").addEventListener("input", function() {
  const sale = Number(this.value);
  const statusSelect = document.getElementById("status-select");

  if (sale === 0) {
    statusSelect.value = "sale";
    statusSelect.disabled = true;
  } else {
    statusSelect.disabled = false;
    if (statusSelect.value === "sale") {
      statusSelect.value = "normal";
    }
  }
});


</script>

<style>
  .product-img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
  }

  @media (max-width: 768px) {
    .admin-table {
      font-size: 12px;
    }
    .product-img {
      width: 45px;
      height: 45px;
    }
  }
</style>

<%- include('../partials/footer') %>
