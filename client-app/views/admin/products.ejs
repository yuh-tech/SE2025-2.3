<%- include('../partials/header') %>

<div class="admin-container">
  <h1>Quản lý sản phẩm</h1>

  <!-- FORM THÊM SẢN PHẨM -->
  <form action="/admin/products/add" method="POST" enctype="multipart/form-data" class="product-form">

    <div class="row">
      <label>Tên sản phẩm</label>
      <input type="text" name="name" required />
    </div>

    <div class="row">
      <label>Giá gốc</label>
      <input type="number" name="price" required />
    </div>

    <div class="row">
      <label>Giá sale</label>
      <input type="number" id="sale-price" name="salePrice" placeholder="0 nếu không sale" />
    </div>

    <div class="row">
      <label>Mô tả ngắn</label>
      <input type="text" name="shortDesc" maxlength="200" required />
    </div>

    <div class="row">
      <label>Ảnh sản phẩm</label>
      <input type="file" name="images[]" multiple />
      <small>Bạn có thể chọn nhiều ảnh. Ảnh đầu tiên sẽ là ảnh chính.</small>
    </div>

    <div class="row">
      <label>Danh mục</label>
      <input type="text" name="category" required />
    </div>

    <!-- VARIANTS -->
    <div class="row">
      <label>Thêm màu + size + SL</label>
      <div id="variant-wrapper"></div>
      <button type="button" class="add-variant-btn">+ Thêm biến thể</button>
    </div>

    <div class="row">
      <label>Mô tả chi tiết</label>
      <textarea name="description" rows="4" required></textarea>
    </div>

    <div class="row">
      <label>Trạng thái</label>
      <select name="status" id="status-select">
        <option value="normal">Bình thường</option>
        <option value="sale">Đang Sale</option>
        <option value="hidden">Ẩn</option>
      </select>
    </div>

    <button class="admin-btn">Thêm sản phẩm</button>
  </form>

  <!-- DANH SÁCH -->
  <div class="admin-card">
    <h2>Danh sách sản phẩm</h2>

    <table class="admin-table">
      <thead>
        <tr>
          <th>Ảnh</th>
          <th>Tên</th>
          <!-- <th>Mô tả ngắn</th> -->
          <th>Giá</th>
          <th>Giá sale</th>
          <th>Danh mục</th>
          <th>Màu sắc</th>
          <th>Số lượng</th>
          <th>Trạng thái</th>
          <th>Chỉnh sửa</th>
          <th>Xóa</th>
        </tr>
      </thead>
      <tbody>
        <% products.forEach(p => { %>
          <tr>
            <!-- ẢNH -->
            <td>
              <% const imgsRaw = p.images || p.image || ''; const imgs = imgsRaw ? String(imgsRaw).split(',') : []; %>
              <% if (imgs.length > 0 && imgs[0]) { %>
                <% const first = imgs[0].trim(); const src = first.startsWith('/') ? first : ('/uploads/' + first); %>
                <img src="<%= src %>" class="product-img" />
                <% if (imgs.length > 1) { %>
                  <button type="button" class="more-img-btn" onclick="showImages('<%= imgs.join(',') %>')">+<%= imgs.length - 1 %></button>
                <% } %>
              <% } else { %>
                —
              <% } %>
            </td>

            <td><%= p.name %></td>

            <!-- shortDescription column removed per request -->

            <td>
              <%= Number(p.price).toLocaleString('vi-VN') %> ₫
            </td>

            <!-- SALE -->
            <td>
              <% if (Number(p.salePrice) > 0) { %>
                <span style="color:green;font-weight:bold;">
                  ✓ <%= Number(p.salePrice).toLocaleString('vi-VN') %> ₫
                </span>
              <% } else { %>
                <span style="color:red;font-weight:bold;">✗</span>
              <% } %>
            </td>

            <td><%= p.category %></td>

            <!-- COLORS -->
            <td>
              <% if (p.colors.length > 0) { %>
                <%= p.colors.join(", ") %>
              <% } else { %>
                —
              <% } %>
            </td>

            <!-- VARIANTS -->
            <td>
              <% if (p.variants.length > 0) { %>
                <% p.variants.forEach(v => { %>
                  <div>
                    <strong><%= v.color %></strong>
                    - Size <%= v.size %>
                    - SL: <%= v.quantity %>
                  </div>
                <% }) %>
              <% } else { %>
                —
              <% } %>
            </td>

            <!-- STATUS -->
            <td>
              <% const st = (p.status || '').toString().trim().toLowerCase(); %>
              <% if (st === 'normal') { %>
                <span style="color:green;">Bình thường</span>
              <% } else if (st === 'sale') { %>
                <span style="color:red;">Sale</span>
              <% } else if (st === 'hidden' || st === 'hide') { %>
                <span style="opacity:0.5;">Ẩn</span>
              <% } else { %>
                <span><%= p.status %></span>
              <% } %>
            </td>

            <!-- EDIT -->
            <td>
              <form action="/admin/products/edit/<%= p.id %>" method="get" style="display:inline">
                <button type="submit" class="edit-btn">Sửa</button>
              </form>
            </td>

            <!-- DELETE -->
            <td>
              <form method="POST" action="/admin/products/delete/<%= p.id %>"
                    onsubmit="return confirm('Xóa sản phẩm này?')">
                <button type="submit" class="delete-btn">Xóa</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>


<script>
  function showImages(list) {
    alert("Danh sách ảnh:\n" + list.split(',').join('\n'));
  }

  function addVariantRow(defaultRow = false) {
    const wrapper = document.getElementById("variant-wrapper");

    const row = document.createElement("div");
    row.className = "variant-row";

    row.innerHTML = `
      <input type="text" name="variant_color[]" placeholder="Màu" ${defaultRow ? 'required' : ''}>
      <input type="text" name="variant_size[]" placeholder="Size" ${defaultRow ? 'required' : ''}>
      <input type="number" name="variant_quantity[]" placeholder="SL" ${defaultRow ? 'required' : ''}>
      <button type="button" class="remove-variant">×</button>
    `;

    row.querySelector(".remove-variant").onclick = () => row.remove();
    wrapper.appendChild(row);
  }

  document.querySelector(".add-variant-btn").onclick = () => addVariantRow();
  addVariantRow(true);

  document.addEventListener("DOMContentLoaded", () => {
    const saleInput = document.getElementById("sale-price");
    const statusSelect = document.getElementById("status-select");

    function updateStatus() {
      const sale = Number(saleInput.value);
      statusSelect.value = sale > 0 ? "sale" : "normal";
      statusSelect.disabled = sale > 0;
    }

    saleInput.addEventListener("input", updateStatus);
    updateStatus();
  });
</script>

<style>
  .product-img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
  }
  .more-img-btn {
    background: #3498db;
    border: none;
    color: white;
    padding: 3px 6px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 5px;
  }
  .sale-yes { color: green; font-weight: bold; }
  .sale-no { color: red; font-weight: bold; }
  .variant-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }
  .variant-row input {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  .remove-variant {
    background: #e74c3c;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
  }
  /* Edit/Delete button styling: same size, edit is blue */
  .edit-btn, .delete-btn {
    display: inline-block;
    padding: 6px 10px;
    min-width: 72px;
    text-align: center;
    border-radius: 6px;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
  }
  .edit-btn { background: #2980b9; }
  .delete-btn { background: #e74c3c; }
</style>

<%- include('../partials/footer') %>
