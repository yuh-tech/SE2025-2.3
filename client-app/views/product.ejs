<%- include('partials/header') %>

<div class="container product-detail-page">
  <div class="breadcrumb">
    <a href="/">Trang chủ</a> → <a href="/products">Sản phẩm</a> →
    <span><%= product.name %></span>
  </div>

  <div class="product-detail-grid">
    <!-- Ảnh bên trái (nhỏ gọn) -->
    <div class="product-gallery">
      <div class="main-image">
        <img src="<%= product.image %>" alt="<%= product.name %>" id="mainImg" />
      </div>
      <div class="thumbnail-list">
        <img src="<%= product.image %>" class="thumb active" onclick="changeImage(this)" />

        <% if (product.gallery && product.gallery.length > 0) { %> <% product.gallery.forEach(img => { %>
        <img src="<%= img %>" class="thumb" onclick="changeImage(this)" />
        <% }) %> <% } else { %>
        <img src="<%= product.image %>" class="thumb" onclick="changeImage(this)" />
        <img src="<%= product.image %>" class="thumb" onclick="changeImage(this)" />
        <img src="<%= product.image %>" class="thumb" onclick="changeImage(this)" />
        <% } %>
      </div>
    </div>

    <!-- Thông tin bên phải -->
    <div class="product-info-right">
      <h1><%= product.name %></h1>

      <div class="rating">
        <% for (let i = 1; i <= 5; i++) { %>
        <i class="fas fa-star <%= i <= (product.rating || 4.8) ? 'filled' : '' %>"></i>
        <% } %>
        <span class="review-count">(128 đánh giá)</span>
      </div>

      <%
  const saleOk = product.salePrice && product.salePrice < product.price;
  const finalPrice = saleOk ? product.salePrice : product.price;
  const discount = (saleOk && product.price > 0)
  ? Math.round((1 - (product.salePrice / product.price)) * 100)
  : 0;

%>

<div class="price-wrap">
  <% if (saleOk) { %>
    <div class="price-old"><%= product.price.toLocaleString('vi-VN') %> ₫</div>
    <div class="price-big"><%= product.salePrice.toLocaleString('vi-VN') %> ₫</div>
    <% if (discount > 0) { %>
      <div class="price-badge">-<%= discount %>%</div>
    <% } %>

  <% } else { %>
    <div class="price-big"><%= product.price.toLocaleString('vi-VN') %> ₫</div>
  <% } %>
</div>



      <div class="short-desc">
        <%= product.shortDesc || 'Thiết kế tinh tế, chất liệu cao cấp, phù hợp mọi dáng người.' %>
      </div>

      <!-- Chọn màu sắc -->
      <div class="option-group">
        <label>Màu sắc:</label>
        <div class="color-options" id="colorOptions"></div>
      </div>


      <!-- Chọn kích cỡ -->
      <div class="option-group">
        <label>Kích cỡ:</label>
        <div class="size-options" id="sizeOptions"></div>
      </div>


      <p class="select-warning" style="color: #e74c3c; font-size: 14px; margin: 12px 0; display: none">
        Vui lòng chọn màu sắc và kích cỡ trước khi thêm vào giỏ!
      </p>

      <div class="qty-row">
        <span class="qty-label">Số lượng</span>
        <div class="qty-box">
          <button type="button" class="qty-btn" id="qtyMinus">–</button>
          <input id="qtyInput" type="number" min="1" value="1" readonly>
          <button type="button" class="qty-btn" id="qtyPlus">+</button>
        </div>
      </div>

      <!-- Nút thêm giỏ -->
      <div class="actions">
        <% if (currentUser) { %>
        <form id="addToCartForm" action="/cart/add/<%= product.id %>" method="POST">
          <input type="hidden" name="color" id="selectedColor" />
          <input type="hidden" name="size" id="selectedSize" />
          <button type="submit" id="addToCartBtn" class="add-to-cart-big" disabled>Thêm vào giỏ hàng</button>
        </form>
        <% } else { %>
        <button id="addToCartBtn" class="add-to-cart-big login-required" disabled>Thêm vào giỏ hàng</button>
        <% } %>

        <a href="/products" class="back-btn">Tiếp tục mua sắm</a>
      </div>

      <!-- Mô tả chi tiết -->
      <div class="details">
        <h3>Chi tiết sản phẩm</h3>
        <p>
          <%= product.description %>
        </p>
      </div>
    </div>
  </div>

  <!-- Đánh giá -->
  <div class="reviews-section">
    <h2>Đánh giá từ khách hàng</h2>
    <div class="review">
      <strong>Lan Anh</strong> ★★★★★
      <p>Áo đẹp lắm ạ, mặc thoải mái, shop gói cẩn thận</p>
    </div>
    <div class="review">
      <strong>Minh Thư</strong> ★★★★☆
      <p>Hàng y hình, giao nhanh, sẽ ủng hộ lâu dài</p>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
<style>
  .product-detail-page {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  .breadcrumb {
    margin-bottom: 25px;
    color: #999;
    font-size: 14px;
  }
  .breadcrumb a {
    color: #ff6b9d;
    text-decoration: none;
  }

  .product-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1.4fr;
    gap: 50px;
    align-items: start;
  }

  /* Ảnh nhỏ gọn */
  .main-image {
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
    margin-bottom: 18px;
  }
  .main-image img {
    width: 100%;
    height: 460px;
    object-fit: cover;
    object-position: center top;
    transition: transform 0.4s ease;
  }
  .main-image img:hover {
    transform: scale(1.05);
  }

  .thumbnail-list {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .thumbnail-list img {
    width: 88px;
    height: 88px;
    object-fit: cover;
    border-radius: 12px;
    cursor: pointer;
    border: 3px solid #eee;
    transition: 0.3s;
  }
  .thumbnail-list img.active,
  .thumbnail-list img:hover {
    border-color: #ff6b9d;
    transform: scale(1.1);
  }

  /* Thông tin bên phải */
  .product-info-right h1 {
    font-size: 29px;
    margin: 0 0 12px;
    color: #333;
  }
  .price-big {
    font-size: 34px;
    font-weight: bold;
    color: #ff6b9d;
    margin: 18px 0;
  }
  .short-desc {
    color: #666;
    line-height: 1.7;
    margin-bottom: 22px;
    font-size: 15px;
  }

  .option-group label {
    display: block;
    margin: 20px 0 10px;
    font-weight: 600;
    font-size: 16px;
  }
  .color-options,
  .size-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .color-btn,
  .size-btn {
    padding: 10px 20px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 30px;
    cursor: pointer;
    transition: 0.3s;
    font-size: 15px;
  }
  .color-btn.selected,
  .size-btn.selected {
    background: #ff6b9d;
    color: white;
    border-color: #ff6b9d;
  }

  .actions {
    margin: 35px 0;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .add-to-cart-big {
    flex: 1;
    min-width: 260px;
    padding: 16px;
    background: #a8e6cf;
    color: #155d42;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: not-allowed;
    opacity: 0.6;
  }
  .add-to-cart-big.enabled {
    opacity: 1;
    cursor: pointer;
  }
  .add-to-cart-big.enabled:hover {
    background: #88d8b0;
    transform: scale(1.02);
  }

  .back-btn {
    padding: 16px 34px;
    background: white;
    color: #ff6b9d;
    border: 2px solid #ff6b9d;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 600;
  }

  .details {
    background: #f9f9f9;
    padding: 28px;
    border-radius: 16px;
    margin-top: 30px;
  }
  .details h3 {
    color: #ff6b9d;
    margin-bottom: 15px;
  }
  .reviews-section {
    margin-top: 80px;
    text-align: center;
  }
  .review {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin: 15px auto;
    max-width: 600px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
    text-align: left;
  }

  @media (max-width: 992px) {
    .product-detail-grid {
      grid-template-columns: 1fr;
    }
    .main-image img {
      height: 420px;
    }
  }

  .price-wrap{
  display:flex;
  align-items: baseline;
  gap: 12px;
  margin: 18px 0 6px;
}
.price-old{
  color:#e74a3b;
  text-decoration: line-through;
  font-size:14px;
}
.price-badge{
  background:#ff6b9d;
  color:#fff;
  font-weight:800;
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
}

.qty-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin: 16px 0 6px;
}
.qty-label{ font-weight:600; }
.qty-box{
  display:flex; align-items:center; gap:10px;
}
.qty-btn{
  width:42px; height:42px;
  border-radius:12px;
  border:1px solid #eee;
  background:#fff;
  cursor:pointer;
}
#qtyInput{
  width:64px; height:42px;
  text-align:center;
  border:1px solid #eee;
  border-radius:12px;
}
</style>

<script>
  function changeImage(thumb) {
    document.getElementById('mainImg').src = thumb.src;
    document.querySelectorAll('.thumb').forEach((t) => t.classList.remove('active'));
    thumb.classList.add('active');
  }

  const VARIANTS = <%- JSON.stringify(variants || []) %>;
  const IS_LOGGED_IN = <%= currentUser ? 'true' : 'false' %>;

  const addBtn = document.getElementById('addToCartBtn');
  const warning = document.querySelector('.select-warning');
  const colorInput = document.getElementById('selectedColor');
  const sizeInput = document.getElementById('selectedSize');

  const colorWrap = document.getElementById('colorOptions');
  const sizeWrap = document.getElementById('sizeOptions');
  

  const qtyInput = document.getElementById('qtyInput');
  const qtyPlus = document.getElementById('qtyPlus');
  const qtyMinus = document.getElementById('qtyMinus');

  let selectedColor = '';
  let selectedSize = '';

  function uniq(arr){ return [...new Set(arr)].filter(Boolean); }
  const ALL_COLORS = uniq(VARIANTS.map(v => v.color));
  const ALL_SIZES  = uniq(VARIANTS.map(v => v.size));

  function getStock(color, size){
    const row = VARIANTS.find(v => v.color === color && v.size === size);
    return row ? Number(row.quantity || 0) : 0;
  }

  function isColorAvailable(color){
    return VARIANTS.some(v => v.color === color && (!selectedSize || v.size === selectedSize) && Number(v.quantity) > 0);
  }
  function isSizeAvailable(size){
    return VARIANTS.some(v => v.size === size && (!selectedColor || v.color === selectedColor) && Number(v.quantity) > 0);
  }

  function renderOptions(){
    // render colors
    colorWrap.innerHTML = '';
    ALL_COLORS.forEach(c => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'color-btn';
      btn.textContent = c;
      btn.dataset.color = c;

      btn.disabled = !isColorAvailable(c);
      if (c === selectedColor) btn.classList.add('selected');

      btn.onclick = () => {
        selectedColor = c;
        selectedSize = ''; // reset để tránh combo sai
        if (colorInput) colorInput.value = selectedColor;
        if (sizeInput) sizeInput.value = '';
        renderOptions();
        checkCanAdd();
      };

      colorWrap.appendChild(btn);
    });

    // render sizes
    sizeWrap.innerHTML = '';
    ALL_SIZES.forEach(s => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'size-btn';
      btn.textContent = s;
      btn.dataset.size = s;

      btn.disabled = !isSizeAvailable(s);
      if (s === selectedSize) btn.classList.add('selected');

      btn.onclick = () => {
        selectedSize = s;
        if (sizeInput) sizeInput.value = selectedSize;
        renderOptions();
        checkCanAdd();
      };

      sizeWrap.appendChild(btn);
    });
  }

  function checkCanAdd() {
    const ready = selectedColor && selectedSize;
    const stock = ready ? getStock(selectedColor, selectedSize) : null;


    if (ready && stock > 0) {
      addBtn.disabled = false;
      addBtn.classList.add('enabled');
      warning.style.display = 'none';

      // giới hạn qty theo tồn kho
      const q = Number(qtyInput?.value || 1);
      if (qtyInput && q > stock) qtyInput.value = stock;
      if (qtyPlus) qtyPlus.disabled = q >= stock;
      if (qtyMinus) qtyMinus.disabled = q <= 1;
    } else {
      addBtn.disabled = true;
      addBtn.classList.remove('enabled');
      if (ready && stock === 0) {
        warning.textContent = 'Biến thể này đã hết hàng!';
        warning.style.display = 'block';
      } else {
        warning.textContent = 'Vui lòng chọn màu sắc và kích cỡ trước khi thêm vào giỏ!';
        warning.style.display = 'none';
      }
    }
  }

  // Qty handlers
  if (qtyPlus && qtyMinus && qtyInput){
    qtyPlus.onclick = () => {
      const stock = getStock(selectedColor, selectedSize);
      const v = Number(qtyInput.value);
      if (selectedColor && selectedSize && v < stock) qtyInput.value = v + 1;
      checkCanAdd();
    };
    qtyMinus.onclick = () => {
      const v = Number(qtyInput.value);
      qtyInput.value = Math.max(1, v - 1);
      checkCanAdd();
    };
  }

  // AJAX add to cart (qty lần). Nếu muốn tối ưu, mình sẽ hướng dẫn sửa backend nhận quantity.
  document.getElementById('addToCartForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();

    if (!selectedColor || !selectedSize) {
      warning.style.display = 'block';
      return;
    }

    if (!IS_LOGGED_IN) {
      location.href = `/login?redirect=${encodeURIComponent(location.pathname)}`;
      return;
    }

    const qty = Number(qtyInput?.value || 1);

    for (let i = 0; i < qty; i++) {
      const r = await fetch(`/cart/add/<%= product.id %>`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ color: selectedColor, size: selectedSize })
      });

      const data = await r.json();
      if (!data.success) {
        alert(data.message || 'Có lỗi xảy ra!');
        return;
      }

      if (window.updateCartBadge && typeof data.cartCount === 'number') {
        window.updateCartBadge(data.cartCount);
      }
    }

    // toast đẹp
    const toast = document.createElement('div');
    toast.textContent = `Đã thêm ${qty} sản phẩm (${selectedSize} - ${selectedColor}) vào giỏ!`;
    toast.style.cssText = `
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:#a8e6cf;color:#155d42;padding:16px 36px;border-radius:50px;
      z-index:9999;font-weight:bold;box-shadow:0 10px 30px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2200);
  });

  // init
  renderOptions();
  checkCanAdd();
</script>
