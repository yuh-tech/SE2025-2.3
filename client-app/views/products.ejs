<%- include('partials/header') %>
<% 
  const _filters = typeof filters !== 'undefined' ? filters : {};
  const search = _filters.search || '';
  const category = _filters.category || 'all';
  const sort = _filters.sort || '';
  const min = _filters.min || '';
  const max = _filters.max || '';
%>

<section class="products-page">
  <h1>Tất cả sản phẩm</h1>

  <div class="container">
    <div class="main-content">

      <!-- THANH LỌC Ở BÊN TRÁI – NHƯ BAN ĐẦU, ĐẸP & GỌN -->
      <aside class="filter-sidebar">
        <h3>Bộ lọc</h3>
        <form method="GET" action="/products" class="filter-form">

          <input type="text" name="search" placeholder="Tìm kiếm..." value="<%= search || '' %>">

          <select name="category">
            <option value="all">Tất cả danh mục</option>
            <% categories.forEach(c => { %>
              <% if (c !== 'all') { %>
                <option value="<%= c %>" <%= category === c ? 'selected' : '' %>><%= c %></option>
              <% } %>
            <% }) %>
          </select>

          <div class="price-range">
            <input type="number" name="min" placeholder="Giá từ" value="<%= min || '' %>">
            <input type="number" name="max" placeholder="Giá đến" value="<%= max || '' %>">
          </div>

          <select name="sort">
            <option value="">Sắp xếp</option>
            <option value="asc" <%= sort === 'asc' ? 'selected' : '' %>>Giá tăng dần</option>
            <option value="desc" <%= sort === 'desc' ? 'selected' : '' %>>Giá giảm dần</option>
          </select>

          <button type="submit" class="apply-btn">Áp dụng</button>
        </form>

        <a href="/products" class="clear-filter">Xóa bộ lọc</a>
      </aside>

      <!-- DANH SÁCH SẢN PHẨM -->
      <section class="products-section">
        <div class="product-grid">
          <% if (products.length === 0) { %>
            <div class="empty-state">
              <p>Không tìm thấy sản phẩm nào phù hợp</p>
              <a href="/products" class="hero-btn">Xem tất cả</a>
            </div>
          <% } else { %>
            <% products.forEach(p => { %>
              <%
                const effective = (typeof p.effectivePrice !== 'undefined' && p.effectivePrice !== null)
                  ? Number(p.effectivePrice)
                  : ((p.status === 'sale' && Number(p.salePrice) > 0) ? Number(p.salePrice) : Number(p.price));
                const original = Number(p.price);
                const isSale = (p.status === 'sale' && Number(p.salePrice) > 0 && effective < original);
              %>
              <div class="product-card">
                <div class="img-wrap">
                  <img src="<%= p.image %>" alt="<%= p.name %>">
                </div>
                <div class="info">
                  <h3><%= p.name %></h3>
                  <div class="price-wrap">
                    <p class="price"><%= effective.toLocaleString('vi-VN') %> ₫</p>
                    <% if (isSale) { %>
                      <p class="price-original"><%= original.toLocaleString('vi-VN') %> ₫</p>
                    <% } %>
                  </div>

                  <button class="quick-add-btn"
                    data-id="<%= p.id %>"
                    data-name="<%= p.name %>"
                    data-price="<%= effective %>"
                    data-image="<%= p.image %>">
                    Thêm vào giỏ
                  </button>

                  <a href="/product/<%= p.id %>" class="detail-btn">Xem chi tiết</a>
                </div>

              </div>
            <% }) %>
          <% } %>
        </div>
      </section>
    </div>
  </div>
</section>

<%- include('partials/quick-add-modal') %>
<div id="toast"></div>
<%- include('partials/footer') %>

<style>
  .products-page { padding: 30px 0; }
  .products-page h1 { text-align: center; font-size: 32px; color: #ff6b9d; margin-bottom: 30px; }

  .container { max-width: 1300px; margin: 0 auto; padding: 0 15px; }
  .main-content { display: flex; gap: 30px; }

  /* THANH LỌC BÊN TRÁI – ĐẸP NHƯ BAN ĐẦU */
  .filter-sidebar {
    flex: 0 0 250px;
    background: white;
    padding: 24px;
    border-radius: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    height: fit-content;
    position: sticky;
    top: 100px;
  }
  .filter-sidebar h3 { margin: 0 0 20px; font-size: 20px; color: #ff6b9d; }
  .filter-form input, .filter-form select {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 14px;
    border: 1px solid #eee;
    border-radius: 12px;
    font-size: 15px;
  }
  .price-range { display: flex; gap: 10px; margin-bottom: 14px; }
  .price-range input { flex: 1; }
  .apply-btn {
    width: 100%;
    padding: 13px;
    background: #ff6b9d;
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 10px;
  }
  .apply-btn:hover { background: #e55a87; }
  .clear-filter {
    display: block;
    text-align: center;
    color: #ff6b9d;
    font-size: 14px;
    text-decoration: none;
  }
  .clear-filter:hover { text-decoration: underline; }

  /* DANH SÁCH SẢN PHẨM */
  .products-section { flex: 1; }
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
    gap: 25px;
  }
  .product-card {
    background: white;
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: 0.3s;
    text-align: center;
  }
  .product-card:hover { transform: translateY(-10px); }
  .img-wrap { height: 300px; overflow: hidden; }
  .product-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.4s; }
  .product-card:hover img { transform: scale(1.08); }
  .info { padding: 18px; }
  .info h3 {
    font-size: 16px;
    height: 48px;
    overflow: hidden;
    margin: 0 0 10px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .price { color: #ff6b9d; font-size: 19px; font-weight: bold; margin: 10px 0; }
  .price-wrap { display: flex; align-items: baseline; justify-content: center; gap: 10px; margin: 10px 0; }
  .price-wrap .price { margin: 0; }
  .price-original { margin: 0; color: #999; font-size: 14px; text-decoration: line-through; }

  .quick-add-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #a8e6cf, #88d8b0);
    color: #155d42;
    border: none;
    border-radius: 30px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    margin: 10px 0;
    transition: all 0.3s;
  }
  .quick-add-btn:hover {
    background: linear-gradient(135deg, #88d8b0, #66cdaa);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(136,216,176,0.4);
  }
  .detail-btn { color: #ff6b9d; font-size: 14px; text-decoration: none; display: block; margin-top: 8px; }

  .empty-state { text-align: center; padding: 60px 20px; color: #999; }

  #toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 16px 40px; border-radius: 50px; font-weight: bold; z-index: 9999;
    opacity: 0; transition: all 0.4s; pointer-events: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }

  @media (max-width: 992px) {
    .main-content { flex-direction: column; }
    .filter-sidebar { order: 2; width: 100%; position: static; }
    .product-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 576px) {
    .product-grid { grid-template-columns: 1fr; }
  }
  /* ===== PRICE SALE STYLE ===== */
.price-box {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin: 10px 0;
}

.price-old {
  color: #e74a3b;
  text-decoration: line-through;
  font-size: 14px;
}

.price-sale {
  color: #ff6b9d;
  font-size: 20px;
  font-weight: bold;
}
.option-btn {
  padding: 8px 14px;
  border-radius: 20px;
  border: 1px solid #ddd;
  cursor: pointer;
}

.option-btn.selected {
  background: #ff6b9d;
  color: white;
}

.option-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}


</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const isLoggedIn = <%= currentUser ? 'true' : 'false' %>;
  const modal = document.getElementById("quickAddModal");
  const toast = document.getElementById("toast");

  let selectedColor = null;
  let selectedSize = null;
  let currentProductId = null;
  window.productOptions = [];

  /* ================= CLICK THÊM GIỎ ================= */
  document.querySelectorAll(".quick-add-btn").forEach(btn => {
    btn.addEventListener("click", function () {

      if (!isLoggedIn) {
        toast.style.background = "#ffb347";
        toast.style.color = "white";
        toast.textContent = "Bạn cần đăng nhập để mua hàng";
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
          location.href = "/login";
        }, 1200);
        return;
      }

      currentProductId = this.dataset.id;

      document.getElementById("modalImg").src = this.dataset.image;
      document.getElementById("modalName").textContent = this.dataset.name;
      document.getElementById("modalPrice").textContent =
        Number(this.dataset.price).toLocaleString("vi-VN") + " ₫";

      selectedColor = null;
      selectedSize = null;

      fetch(`/api/product-options/${currentProductId}`)
        .then(res => res.json())
        .then(data => {
          window.productOptions = data;
          renderColors();
          renderSizes();
          checkReady();
          modal.style.display = "flex";
        });
    });
  });

  /* ================= RENDER COLOR ================= */
  function renderColors() {
    const box = document.getElementById("colorOptions");
    box.innerHTML = "";

    const colors = [...new Set(window.productOptions.map(o => o.color))];

    colors.forEach(color => {
      const btn = document.createElement("button");
      btn.textContent = color;
      btn.className = "option-btn";

      if (!isColorAvailable(color)) btn.disabled = true;
      if (color === selectedColor) btn.classList.add("selected");

      btn.onclick = () => {
        selectedColor = color;
        selectedSize = null;
        renderColors();
        renderSizes();
        checkReady();
      };

      box.appendChild(btn);
    });
  }

  /* ================= RENDER SIZE ================= */
  function renderSizes() {
    const box = document.getElementById("sizeOptions");
    box.innerHTML = "";

    const sizes = [...new Set(window.productOptions.map(o => o.size))];

    sizes.forEach(size => {
      const btn = document.createElement("button");
      btn.textContent = size;
      btn.className = "option-btn";

      if (!isSizeAvailable(size)) btn.disabled = true;
      if (size === selectedSize) btn.classList.add("selected");

      btn.onclick = () => {
        selectedSize = size;
        renderColors();
        renderSizes();
        checkReady();
      };

      box.appendChild(btn);
    });
  }

  function isColorAvailable(color) {
    return window.productOptions.some(
      o =>
        o.color === color &&
        (!selectedSize || o.size === selectedSize) &&
        o.quantity > 0
    );
  }

  function isSizeAvailable(size) {
    return window.productOptions.some(
      o =>
        o.size === size &&
        (!selectedColor || o.color === selectedColor) &&
        o.quantity > 0
    );
  }

  function checkReady() {
    const btn = document.getElementById("modalAddBtn");
    btn.disabled = !(selectedColor && selectedSize);
  }

  /* ================= ADD TO CART ================= */
  document.getElementById("modalAddBtn").addEventListener("click", () => {
    if (!selectedColor || !selectedSize) return;

    fetch(`/cart/add/${currentProductId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        color: selectedColor,
        size: selectedSize
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        modal.style.display = "none";
        toast.style.background = "#a8e6cf";
        toast.style.color = "#155d42";
        toast.textContent = `Đã thêm ${selectedSize} - ${selectedColor} vào giỏ`;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);

        if (window.updateCartBadge && typeof data.cartCount === "number") {
          window.updateCartBadge(data.cartCount);
        }
      }
    });
  });

  /* ================= CLOSE MODAL ================= */
  document.querySelector(".modal-close")?.addEventListener("click", () => {
    modal.style.display = "none";
  });

  window.addEventListener("click", e => {
    if (e.target === modal) modal.style.display = "none";
  });

});
</script>
