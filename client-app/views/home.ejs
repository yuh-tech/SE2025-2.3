<%- include('partials/header') %>

<section class="hero">
  <h1>Chào mừng đến Sunshine Boutique</h1>
  <p>Thời trang mang màu sắc nhẹ nhàng, tinh chiết – dành cho bạn.</p>
  <a href="/products" class="hero-btn">Khám phá ngay</a>
</section>

<section class="suggest-section">
  <h2>Gợi ý cho bạn</h2>

  <div class="product-grid">
    <% products.slice(0, 4).forEach(p => { %>
      <div class="product-card">
        <img src="<%= p.image %>" alt="<%= p.name %>">
        <h3><%= p.name %></h3>
        <p class="price"><%= p.price.toLocaleString('vi-VN') %> ₫</p>

        <button class="quick-add-btn"
                data-id="<%= p.id %>"
                data-name="<%= p.name %>"
                data-price="<%= p.price %>"
                data-image="<%= p.image %>">
          Thêm vào giỏ
        </button>

        <a class="detail-btn" href="/product/<%= p.id %>">Xem chi tiết</a>
      </div>
    <% }) %>
  </div>
</section>

<%- include('partials/quick-add-modal') %>
<div id="toast"></div>
<div id="__ctx" data-logged-in="<%= currentUser ? '1' : '0' %>" style="display:none;"></div>

<%- include('partials/footer') %>

<style>
  .quick-add-btn {
    margin-top: 8px; width: 100%; padding: 10px; background: #a8e6cf; color: #155d42;
    border: none; border-radius: 30px; font-weight: 600; font-size: 14px; cursor: pointer;
    transition: 0.3s;
  }
  .quick-add-btn:hover { background: #88d8b0; transform: translateY(-2px); }

  #toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 16px 36px; border-radius: 50px; font-weight: bold; z-index: 9999;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; transition: all 0.4s; pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
</style>

<script>
  // FIX 100%: luôn đúng dù currentUser là null
  const isLoggedIn = document.getElementById('__ctx')?.dataset?.loggedIn === '1';
  const modal = document.getElementById('quickAddModal');
  const toast = document.getElementById('toast');

  let selectedColor = null;
  let selectedSize = null;
  let currentProductId = null;
  let productOptions = [];

  function renderColors() {
    const box = document.getElementById('colorOptions');
    box.innerHTML = '';
    const colors = [...new Set(productOptions.map(o => o.color))];
    colors.forEach(color => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = color;
      btn.className = 'option-btn' + (color === selectedColor ? ' selected' : '');
      btn.disabled = !productOptions.some(o => o.color === color && (!selectedSize || o.size === selectedSize) && o.quantity > 0);
      btn.onclick = () => {
        selectedColor = color;
        selectedSize = null;
        renderColors();
        renderSizes();
        checkReady();
      };
      box.appendChild(btn);
    });
  }

  function renderSizes() {
    const box = document.getElementById('sizeOptions');
    box.innerHTML = '';
    const sizes = [...new Set(productOptions.map(o => o.size))];
    sizes.forEach(size => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = size;
      btn.className = 'option-btn' + (size === selectedSize ? ' selected' : '');
      btn.disabled = !productOptions.some(o => o.size === size && (!selectedColor || o.color === selectedColor) && o.quantity > 0);
      btn.onclick = () => {
        selectedSize = size;
        renderColors();
        renderSizes();
        checkReady();
      };
      box.appendChild(btn);
    });
  }

  function checkReady() {
    const addBtn = document.getElementById('modalAddBtn');
    addBtn.disabled = !(selectedColor && selectedSize);
    document.querySelector('.modal-warning').style.display = (selectedColor && selectedSize) ? 'none' : 'none';
  }

  document.querySelectorAll('.quick-add-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (!isLoggedIn) {
        toast.style.background = '#ffb347'; toast.style.color = 'white';
        toast.textContent = 'Vui lòng đăng nhập để mua sắm nhé';
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          location.href = `/login?redirect=${encodeURIComponent(location.pathname)}`;
        }, 1200);
        return;
      }

      currentProductId = this.dataset.id;
      selectedColor = null;
      selectedSize = null;

      document.getElementById('modalImg').src = this.dataset.image;
      document.getElementById('modalName').textContent = this.dataset.name;
      document.getElementById('modalPrice').textContent =
        Number(this.dataset.price).toLocaleString('vi-VN') + ' ₫';

      const addBtn = document.getElementById('modalAddBtn');
      addBtn.disabled = true;
      addBtn.dataset.id = currentProductId;

      fetch(`/api/product-options/${currentProductId}`)
        .then(r => r.json())
        .then(rows => {
          productOptions = Array.isArray(rows) ? rows : [];
          if (!productOptions.length) {
            // Fallback cho sản phẩm không có variants trong DB
            productOptions = [{ color: 'Mặc định', size: 'FREESIZE', quantity: 999 }];
          }
          renderColors();
          renderSizes();
          checkReady();
          modal.style.display = 'flex';
        })
        .catch(err => {
          console.error('Lỗi load options:', err);
          // Dù lỗi vẫn cho phép chọn freesize để không chặn mua hàng
          productOptions = [{ color: 'Mặc định', size: 'FREESIZE', quantity: 999 }];
          renderColors();
          renderSizes();
          checkReady();
          modal.style.display = 'flex';
          toast.style.background = '#ffb347';
          toast.style.color = 'white';
          toast.textContent = 'Không tải được màu/size, dùng FREESIZE';
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 2000);
        });
    });
  });

  document.getElementById('modalAddBtn').addEventListener('click', function() {
    if (!selectedColor || !selectedSize) {
      document.querySelector('.modal-warning').style.display = 'block';
      return;
    }

    fetch(`/cart/add/${currentProductId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ color: selectedColor, size: selectedSize })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        modal.style.display = 'none';
        toast.style.background = '#a8e6cf';
        toast.style.color = '#155d42';
        toast.textContent = `Đã thêm ${selectedSize} - ${selectedColor} vào giỏ!`;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
        if (window.updateCartBadge && typeof data.cartCount === 'number') window.updateCartBadge(data.cartCount);
      } else {
        toast.style.background = '#ff4444';
        toast.style.color = 'white';
        toast.textContent = data.message || 'Không thể thêm vào giỏ';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
      }
    })
    .catch(err => {
      console.error('Lỗi thêm vào giỏ:', err);
      toast.style.background = '#ff4444';
      toast.style.color = 'white';
      toast.textContent = 'Có lỗi xảy ra!';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    });
  });

  // Đóng modal
  document.querySelector('.modal-close')?.addEventListener('click', () => modal.style.display = 'none');
  window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
</script>