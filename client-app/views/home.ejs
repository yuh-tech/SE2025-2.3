<%- include('partials/header') %>

<section class="hero">
  <h1>Chào mừng đến Sunshine Boutique</h1>
  <p>Thời trang mang màu sắc nhẹ nhàng, tinh chiết – dành cho bạn.</p>
  <a href="/products" class="hero-btn">Khám phá ngay</a>
</section>

<section class="suggest-section">
  <h2>Gợi ý cho bạn</h2>

  <div class="product-grid">
    <% products.slice(0, 4).forEach(p => { %>
      <div class="product-card">
        <img src="<%= p.image %>" alt="<%= p.name %>">
        <h3><%= p.name %></h3>
        <p class="price"><%= p.price.toLocaleString('vi-VN') %> ₫</p>

        <button class="quick-add-btn"
                data-id="<%= p.id %>"
                data-name="<%= p.name %>"
                data-price="<%= p.price %>"
                data-image="<%= p.image %>">
          Thêm vào giỏ
        </button>

        <a class="detail-btn" href="/product/<%= p.id %>">Xem chi tiết</a>
      </div>
    <% }) %>
  </div>
</section>

<%- include('partials/quick-add-modal') %>
<div id="toast"></div>
<div id="__ctx" data-logged-in="<%= currentUser ? '1' : '0' %>" style="display:none;"></div>

<%- include('partials/footer') %>

<style>
  .quick-add-btn {
    margin-top: 8px; width: 100%; padding: 10px; background: #a8e6cf; color: #155d42;
    border: none; border-radius: 30px; font-weight: 600; font-size: 14px; cursor: pointer;
    transition: 0.3s;
  }
  .quick-add-btn:hover { background: #88d8b0; transform: translateY(-2px); }

  #toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 16px 36px; border-radius: 50px; font-weight: bold; z-index: 9999;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; transition: all 0.4s; pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const isLoggedIn = <%= currentUser ? 'true' : 'false' %>;
  const modal = document.getElementById("quickAddModal");
  const toast = document.getElementById("toast");

  let selectedColor = null;
  let selectedSize = null;
  let currentProductId = null;
  window.productOptions = [];

  /* ================= CLICK THÊM GIỎ ================= */
  document.querySelectorAll(".quick-add-btn").forEach(btn => {
    btn.addEventListener("click", function () {

      if (!isLoggedIn) {
        toast.style.background = "#ffb347";
        toast.style.color = "white";
        toast.textContent = "Bạn cần đăng nhập để mua hàng";
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
          location.href = "/login";
        }, 1200);
        return;
      }

      currentProductId = this.dataset.id;

      document.getElementById("modalImg").src = this.dataset.image;
      document.getElementById("modalName").textContent = this.dataset.name;
      document.getElementById("modalPrice").textContent =
        Number(this.dataset.price).toLocaleString("vi-VN") + " ₫";

      selectedColor = null;
      selectedSize = null;

      fetch(`/api/product-options/${currentProductId}`)
        .then(res => res.json())
        .then(data => {
          window.productOptions = data;
          renderColors();
          renderSizes();
          checkReady();
          modal.style.display = "flex";
        });
    });
  });

  /* ================= RENDER COLOR ================= */
  function renderColors() {
    const box = document.getElementById("colorOptions");
    box.innerHTML = "";

    const colors = [...new Set(window.productOptions.map(o => o.color))];

    colors.forEach(color => {
      const btn = document.createElement("button");
      btn.textContent = color;
      btn.className = "option-btn";

      if (!isColorAvailable(color)) btn.disabled = true;
      if (color === selectedColor) btn.classList.add("selected");

      btn.onclick = () => {
        selectedColor = color;
        selectedSize = null;
        renderColors();
        renderSizes();
        checkReady();
      };

      box.appendChild(btn);
    });
  }

  /* ================= RENDER SIZE ================= */
  function renderSizes() {
    const box = document.getElementById("sizeOptions");
    box.innerHTML = "";

    const sizes = [...new Set(window.productOptions.map(o => o.size))];

    sizes.forEach(size => {
      const btn = document.createElement("button");
      btn.textContent = size;
      btn.className = "option-btn";

      if (!isSizeAvailable(size)) btn.disabled = true;
      if (size === selectedSize) btn.classList.add("selected");

      btn.onclick = () => {
        selectedSize = size;
        renderColors();
        renderSizes();
        checkReady();
      };

      box.appendChild(btn);
    });
  }

  function isColorAvailable(color) {
    return window.productOptions.some(
      o =>
        o.color === color &&
        (!selectedSize || o.size === selectedSize) &&
        o.quantity > 0
    );
  }

  function isSizeAvailable(size) {
    return window.productOptions.some(
      o =>
        o.size === size &&
        (!selectedColor || o.color === selectedColor) &&
        o.quantity > 0
    );
  }

  function checkReady() {
    const btn = document.getElementById("modalAddBtn");
    btn.disabled = !(selectedColor && selectedSize);
  }

  /* ================= ADD TO CART ================= */
  document.getElementById("modalAddBtn").addEventListener("click", () => {
    if (!selectedColor || !selectedSize) return;

    fetch(`/cart/add/${currentProductId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        color: selectedColor,
        size: selectedSize
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        modal.style.display = "none";
        toast.style.background = "#a8e6cf";
        toast.style.color = "#155d42";
        toast.textContent = `Đã thêm ${selectedSize} - ${selectedColor} vào giỏ`;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);

        if (window.updateCartBadge && typeof data.cartCount === "number") {
          window.updateCartBadge(data.cartCount);
        }
      }
    });
  });

  /* ================= CLOSE MODAL ================= */
  document.querySelector(".modal-close")?.addEventListener("click", () => {
    modal.style.display = "none";
  });

  window.addEventListener("click", e => {
    if (e.target === modal) modal.style.display = "none";
  });

});
</script>